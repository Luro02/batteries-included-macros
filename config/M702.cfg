[include utils/utils.cfg]
[include G28.cfg]

# This macro implements the M702 gcode, which unloads filament from the extruder.
#
# It is based on the marlin implementation.
#
# Usage:
#     M702
# Parameters:
[gcode_macro M702]
description: Unload filament from the extruder.
gcode:
    {% set FILAMENT_CHANGE_UNLOAD_LENGTH = params.FILAMENT_CHANGE_UNLOAD_LENGTH|default(100)|float %}

    {% set FILAMENT_UNLOAD_PURGE_RETRACT = params.FILAMENT_UNLOAD_PURGE_RETRACT|default(13)|float %}
    {% set FILAMENT_CHANGE_UNLOAD_FEEDRATE = params.FILAMENT_CHANGE_UNLOAD_FEEDRATE|default(20)|float %}
    {% set PAUSE_PARK_RETRACT_FEEDRATE = params.PAUSE_PARK_RETRACT_FEEDRATE|default(60)|float %}
    {% set FILAMENT_UNLOAD_PURGE_DELAY = params.FILAMENT_UNLOAD_PURGE_DELAY|default(5000)|float %}
    {% set FILAMENT_UNLOAD_PURGE_LENGTH = params.FILAMENT_UNLOAD_PURGE_LENGTH|default(8)|float %}
    {% set FILAMENT_UNLOAD_PURGE_FEEDRATE = params.FILAMENT_UNLOAD_PURGE_FEEDRATE|default(25)|float %}
    {% set FILAMENT_CHANGE_UNLOAD_ACCEL = params.FILAMENT_CHANGE_UNLOAD_ACCEL|default(25)|float %}
    {% set FILAMENT_CHANGE_FAST_LOAD_ACCEL = params.FILAMENT_CHANGE_FAST_LOAD_ACCEL|default(25)|float %}

    {% set MIN_EXTRUSION_TEMP = params.TEMP|default(180)|float %}

    SAVE_GCODE_STATE NAME=_m702_state

    _MIN_TEMP_CHECK T={MIN_EXTRUSION_TEMP}   # heat to temp
    G28 O                                    # home printer if needed
    M117 Unloading Filament

    # retract filament:
    _unscaled_e_move LENGTH=-{FILAMENT_UNLOAD_PURGE_RETRACT} FEED_RATE={PAUSE_PARK_RETRACT_FEEDRATE}

    # wait for filament to cool
    G4 P{FILAMENT_UNLOAD_PURGE_DELAY}

    # quickly purge
    _unscaled_e_move LENGTH={FILAMENT_UNLOAD_PURGE_RETRACT + FILAMENT_UNLOAD_PURGE_LENGTH} FEED_RATE={FILAMENT_UNLOAD_PURGE_FEEDRATE}

    # unload filament
    {% if FILAMENT_CHANGE_UNLOAD_ACCEL > 0 %}
        {% set SAVED_ACCELERATION = printer.toolhead.max_accel|float %}
        # SET_GCODE_VARIABLE MACRO=M702 VARIABLE=saved_acceleration VALUE={printer.toolhead.max_accel}
        M204 S{FILAMENT_CHANGE_UNLOAD_ACCEL}
    {% endif %}

    _unscaled_e_move LENGTH=-{FILAMENT_CHANGE_UNLOAD_LENGTH} FEED_RATE={FILAMENT_CHANGE_UNLOAD_FEEDRATE}

    {% if FILAMENT_CHANGE_FAST_LOAD_ACCEL > 0 %}
        M204 S{SAVED_ACCELERATION}
    {% endif %}

    # disable the extruder for manual change
    M18 E

    RESTORE_GCODE_STATE NAME=_m702_state
